name: build-release

on:
  push:
    branches: [ main ]
    tags: [ "v*" ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    env:
      APPLE_CERTIFICATE: ${{ secrets.APPLE_CERTIFICATE }}
      APPLE_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
      APPLE_SIGNING_IDENTITY: ${{ secrets.APPLE_SIGNING_IDENTITY }}
      APPLE_ID: ${{ secrets.APPLE_ID }}
      APPLE_PASSWORD: ${{ secrets.APPLE_PASSWORD }}
      APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            artifact_suffix: linux-x64
          - os: windows-latest
            artifact_suffix: windows-x64
          - os: macos-14
            artifact_suffix: macos-arm64
    runs-on: ${{ matrix.os }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: npm
          cache-dependency-path: ui/package-lock.json

      - name: Cache cargo
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: |
            . -> target
            src-tauri -> src-tauri/target

      - name: Install frontend dependencies
        working-directory: ui
        run: npm ci

      - name: Preflight frontend workspace
        shell: bash
        run: |
          set -euo pipefail
          if [ ! -f "ui/package.json" ]; then
            echo "Missing ui/package.json"
            echo "Hint: this workflow expects frontendDist=../ui/dist and a React workspace at ui/."
            exit 1
          fi

      - name: Build frontend assets
        working-directory: ui
        run: npm run build

      - name: Verify frontendDist
        shell: bash
        run: |
          set -euo pipefail
          if [ ! -d "ui/dist" ] || [ ! -f "ui/dist/index.html" ]; then
            echo "Missing ui/dist build output."
            echo "Hint: ensure 'npm --prefix ui run build' succeeds and tauri.conf frontendDist points to ../ui/dist."
            exit 1
          fi
          echo "frontendDist is ready: ui/dist"

      - name: Install Linux dependencies
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libwebkit2gtk-4.1-dev \
            libappindicator3-dev \
            librsvg2-dev \
            patchelf \
            aria2

      - name: Install macOS dependencies
        if: runner.os == 'macOS'
        run: |
          brew update
          brew install aria2

      - name: Install Windows dependencies
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          choco install aria2 -y --no-progress

      - name: Prepare macOS signing keychain
        if: runner.os == 'macOS' && env.APPLE_CERTIFICATE != ''
        shell: bash
        run: |
          set -euo pipefail
          CERT_PATH="$RUNNER_TEMP/build_certificate.p12"
          KEYCHAIN_PATH="$RUNNER_TEMP/app-signing.keychain-db"
          echo -n "$APPLE_CERTIFICATE" | base64 --decode -o "$CERT_PATH"
          security create-keychain -p "" "$KEYCHAIN_PATH"
          security set-keychain-settings "$KEYCHAIN_PATH"
          security unlock-keychain -p "" "$KEYCHAIN_PATH"
          security import "$CERT_PATH" -P "$APPLE_CERTIFICATE_PASSWORD" -A -t cert -f pkcs12 -k "$KEYCHAIN_PATH"
          security list-keychains -d user -s "$KEYCHAIN_PATH" $(security list-keychains -d user | sed 's/[ \"]//g')
          security set-key-partition-list -S apple-tool:,apple: -k "" "$KEYCHAIN_PATH"

      - name: Stage aria2 binary (Linux/macOS)
        if: runner.os != 'Windows'
        run: |
          bash scripts/ci/prepare_aria2_unix.sh

      - name: Stage aria2 binary (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          ./scripts/ci/prepare_aria2_windows.ps1

      - name: Verify staged aria2 (Linux/macOS)
        if: runner.os != 'Windows'
        shell: bash
        run: |
          set -euo pipefail
          case "${RUNNER_OS}" in
            Linux) platform="linux" ;;
            macOS) platform="macos" ;;
            *) echo "unsupported runner os: ${RUNNER_OS}" ; exit 1 ;;
          esac
          test -x "aria2/bin/aria2c"
          test -x "aria2/bin/${platform}/aria2c"
          test -x "src-tauri/resources/aria2/bin/aria2c"
          test -x "src-tauri/resources/aria2/bin/${platform}/aria2c"
          aria2/bin/aria2c --version | head -n 1
          src-tauri/resources/aria2/bin/aria2c --version | head -n 1

      - name: Verify staged aria2 (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          $paths = @(
            "aria2/bin/aria2c.exe",
            "aria2/bin/windows/aria2c.exe",
            "src-tauri/resources/aria2/bin/aria2c.exe",
            "src-tauri/resources/aria2/bin/windows/aria2c.exe"
          )
          foreach ($p in $paths) {
            if (!(Test-Path $p)) { throw "missing staged aria2 binary: $p" }
          }
          & "aria2/bin/aria2c.exe" --version | Select-Object -First 1
          & "src-tauri/resources/aria2/bin/aria2c.exe" --version | Select-Object -First 1

      - name: Install tauri-cli
        run: cargo install tauri-cli --version "^2.0" --locked

      - name: Build app bundle (non-macOS)
        if: runner.os != 'macOS'
        working-directory: src-tauri
        run: cargo tauri build

      - name: Build app bundle (macOS signed/notarized)
        if: runner.os == 'macOS' && env.APPLE_CERTIFICATE != ''
        working-directory: src-tauri
        run: cargo tauri build

      - name: Build app bundle (macOS unsigned fallback)
        if: runner.os == 'macOS' && env.APPLE_CERTIFICATE == ''
        working-directory: src-tauri
        run: |
          echo "WARNING: Missing APPLE_CERTIFICATE secrets. DMG will be unsigned/unnotarized and macOS may report it as damaged."
          cargo tauri build
          mkdir -p target/release/bundle/metadata
          cat > target/release/bundle/metadata/UNSIGNED-MACOS-BUILD.txt << 'EOF'
          This macOS artifact is unsigned and not notarized.
          Configure APPLE_CERTIFICATE/APPLE_SIGNING_IDENTITY/APPLE_ID/APPLE_PASSWORD/APPLE_TEAM_ID for signed releases.
          EOF

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: flamingo-${{ matrix.artifact_suffix }}
          path: |
            src-tauri/target/release/bundle/**/*.dmg
            src-tauri/target/release/bundle/**/*.msi
            src-tauri/target/release/bundle/**/*.exe
            src-tauri/target/release/bundle/**/*.AppImage
            src-tauri/target/release/bundle/**/*.deb
            src-tauri/target/release/bundle/**/*.rpm
            src-tauri/target/release/bundle/**/*.app.tar.gz
            src-tauri/target/release/bundle/metadata/*.txt
          if-no-files-found: error

  release:
    if: startsWith(github.ref, 'refs/tags/v')
    needs: [ build ]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: release-assets
          merge-multiple: false

      - name: Verify release assets
        shell: bash
        run: |
          set -euo pipefail
          echo "Collected release assets:"
          find release-assets -type f -print
          count="$(find release-assets -type f | wc -l | tr -d ' ')"
          if [ "${count}" -eq 0 ]; then
            echo "No release assets found under release-assets/"
            exit 1
          fi
          echo "Asset file count: ${count}"

      - name: Normalize artifact names + checksums
        shell: bash
        run: |
          set -euo pipefail
          tag="${GITHUB_REF_NAME:-${GITHUB_REF##*/}}"
          mkdir -p release-assets-flat
          shopt -s globstar nullglob

          linux_count=0
          windows_count=0
          macos_count=0

          for f in release-assets/**/*; do
            [ -f "$f" ] || continue
            bn="$(basename "$f")"
            platform="unknown"
            case "$f" in
              *flamingo-linux-x64/*) platform="linux-x64"; linux_count=$((linux_count + 1)) ;;
              *flamingo-windows-x64/*) platform="windows-x64"; windows_count=$((windows_count + 1)) ;;
              *flamingo-macos-arm64/*) platform="macos-arm64"; macos_count=$((macos_count + 1)) ;;
            esac

            ext=""
            case "$bn" in
              *.AppImage) ext=".AppImage" ;;
              *.dmg) ext=".dmg" ;;
              *.msi) ext=".msi" ;;
              *.exe) ext=".exe" ;;
              *.deb) ext=".deb" ;;
              *.rpm) ext=".rpm" ;;
              *.app.tar.gz) ext=".app.tar.gz" ;;
              *.tar.gz) ext=".tar.gz" ;;
              *.zip) ext=".zip" ;;
              *) continue ;;
            esac

            out="Flamingo-Downloader-${tag}-${platform}${ext}"
            cp "$f" "release-assets-flat/$out"
          done

          if [ "$linux_count" -eq 0 ] || [ "$windows_count" -eq 0 ] || [ "$macos_count" -eq 0 ]; then
            echo "Expected artifacts missing: linux=$linux_count windows=$windows_count macos=$macos_count"
            exit 1
          fi

          if ! find release-assets-flat -type f | grep -q .; then
            echo "No normalized release assets generated"
            exit 1
          fi

          (cd release-assets-flat && sha256sum * > SHA256SUMS.txt)
          echo "Normalized assets:"
          find release-assets-flat -type f -print

      - name: Generate release notes
        shell: bash
        run: |
          set -euo pipefail
          tag="${GITHUB_REF_NAME:-${GITHUB_REF##*/}}"
          cp .github/RELEASE_TEMPLATE.md release-notes.md
          sed -i "s/__VERSION__/${tag}/g" release-notes.md
          {
            echo ""
            echo "## Artifacts"
            find release-assets-flat -maxdepth 1 -type f \
              | sed 's#^.*/##' \
              | sort \
              | sed 's/^/- /'
          } >> release-notes.md

      - name: Publish GitHub release
        uses: softprops/action-gh-release@v2
        with:
          files: release-assets-flat/**/*
          fail_on_unmatched_files: false
          overwrite_files: true
          body_path: release-notes.md
